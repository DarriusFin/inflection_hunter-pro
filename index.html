<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>拐点猎手 · Inflection Hunter Pro v6.3.2 │ Darrius FinTech Inc</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<style>
:root{--bg:#0b0f17;--panel:#141a24;--panel2:#0f1522;--border:#2a3244;--text:#e6edf3;--muted:#9aa4b2;--green:#00ff88;--red:#ff4757;--blue:#00d4ff;}
*{box-sizing:border-box}
body{margin:0;background:radial-gradient(circle at top left,#182035,#0b0f17);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;}
#topbar{height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 18px;background:rgba(20,26,36,.95);border-bottom:1px solid var(--border);gap:12px;}
#brand{display:flex;align-items:center;gap:14px;min-width:260px;}
#logo{font-size:26px;font-weight:900;background:linear-gradient(90deg,var(--green),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:.5px;}
#brandMeta{line-height:1.1}
#brandTitle{font-weight:900}
#subtitle{font-size:12px;color:var(--muted);margin-top:2px}
#topRight{display:flex;align-items:center;justify-content:flex-end;gap:10px;flex:1;min-width:0;}
#status{padding:7px 12px;border-radius:999px;font-size:12px;background:#1e2533;border:1px solid rgba(255,255,255,0.06);white-space:nowrap;}
.topBtn{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,0.10);background:#1e2533;color:var(--text);cursor:pointer;font-weight:900;font-size:12px;white-space:nowrap;}
.topBtn.primary{background:linear-gradient(90deg,var(--green),var(--blue));color:#000;border:none;}
#copyright{font-size:12px;color:#fff;opacity:0.85;background:rgba(0,0,0,0.35);border:1px solid rgba(255,255,255,0.08);padding:6px 12px;border-radius:999px;white-space:nowrap;max-width:38vw;overflow:hidden;text-overflow:ellipsis;}
#main{display:grid;grid-template-columns:320px 1fr 360px;height:calc(100vh - 64px);}
.panel{background:var(--panel);border-right:1px solid var(--border);padding:16px;overflow:auto;}
.panel:last-child{border-right:none;}
.panel h3{margin:0 0 12px;font-size:14px;color:var(--green);display:flex;align-items:center;gap:8px;}
.panel h3::before{content:"◆";font-size:11px;opacity:.9}
#pulse{display:flex;align-items:center;justify-content:center;height:160px;}
#pulseCircle{width:122px;height:122px;border-radius:50%;border:10px solid var(--green);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900;background:rgba(0,0,0,.25);}
#pulseLabel{text-align:center;margin-top:8px;font-size:12px;color:var(--muted);line-height:1.4;}
.box{border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--panel2);}
.kv{display:flex;justify-content:space-between;gap:10px;margin:6px 0;font-size:13px}
.kv .k{color:var(--muted)} .kv .v{font-weight:900}
.row{display:flex;gap:8px;margin-top:10px}
.toggle{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--panel2);font-size:13px;}
.toggle input{transform:scale(1.05)}
.badge{font-size:11px;padding:3px 8px;border-radius:999px;background:#26304a;border:1px solid rgba(255,255,255,0.08);color:#cfe8ff;}
#chartWrap{position:relative;height:100%;}
#chartBox{position:absolute;inset:0;display:flex;flex-direction:column;}
#chartTop{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;z-index:10;}
#price{background:rgba(0,0,0,.6);padding:8px 12px;border-radius:12px;font-weight:900;border:1px solid rgba(255,255,255,0.10);}
#hint{background:rgba(0,0,0,.55);padding:8px 12px;border-radius:12px;font-size:12px;color:var(--muted);border:1px solid rgba(255,255,255,0.10);max-width:56%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
#chart{flex:1;width:100%;}
label.small{font-size:12px;color:var(--muted);display:block;margin-top:6px}
input,select,button{width:100%;margin:6px 0;padding:10px 10px;border-radius:10px;border:1px solid var(--border);background:var(--panel2);color:var(--text);font-size:13px;}
button{cursor:pointer;font-weight:900;}
button.primary{background:linear-gradient(90deg,var(--green),var(--blue));color:#000;border:none;}
button.ghost{background:#1e2533;}
.signal{border-left:4px solid var(--green);padding:10px;margin:8px 0;background:var(--panel2);border-radius:10px;font-size:13px;border:1px solid rgba(255,255,255,0.06);}
.signal.sell{border-left-color:var(--red)}
.smallTxt{font-size:12px;color:var(--muted);line-height:1.5;}
.hr{height:1px;background:rgba(255,255,255,.06);margin:12px 0}
.footer{text-align:center;font-size:12px;color:var(--muted);margin-top:12px;line-height:1.55;}
#toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:rgba(0,0,0,.75);border:1px solid rgba(255,255,255,.14);padding:10px 14px;border-radius:999px;font-size:13px;color:#fff;z-index:99999;display:none;max-width:92vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
@media (max-width:1080px){#main{grid-template-columns:1fr;height:auto}.panel{border-right:none;border-bottom:1px solid var(--border)}#chartWrap{height:60vh}#copyright{display:none}#hint{max-width:70%}}
</style>
</head>
<body>

<div id="topbar">
  <div id="brand">
    <div id="logo">拐点猎手</div>
    <div id="brandMeta">
      <div id="brandTitle">Inflection Hunter Pro</div>
      <div id="subtitle">Darrius FinTech Inc</div>
    </div>
  </div>

  <div id="topRight">
    <span id="status">Demo Mode · 演示模式</span>
    <button id="manageBtn" class="topBtn" style="display:none" onclick="simulatePortal()">Manage / Cancel · 管理订阅</button>
    <button id="upgradeBtn" class="topBtn primary" onclick="simulateCheckout()">Start Trial / Upgrade · 试用/升级</button>
    <span id="copyright">© 2025 Darrius FinTech Inc. All Rights Reserved.</span>
  </div>
</div>

<div id="main">
  <div class="panel">
    <h3>Market Pulse · 市场情绪</h3>
    <div id="pulse"><div id="pulseCircle">--</div></div>
    <div id="pulseLabel">Loading… / 加载中…</div>

    <div class="hr"></div>

    <h3>Risk Copilot · 风控助手</h3>
    <div class="box">
      <div class="kv"><span class="k">Entry · 入场</span><span class="v" id="riskEntry">--</span></div>
      <div class="kv"><span class="k">Stop · 止损</span><span class="v" id="riskStop">--</span></div>
      <div class="kv"><span class="k">Targets · 目标</span><span class="v" id="riskTargets">--</span></div>
      <div class="kv"><span class="k">Confidence · 强度</span><span class="v" id="riskConf">--</span></div>
      <div class="kv"><span class="k">Backtest WinRate · 回测胜率</span><span class="v" id="riskWR">--</span></div>
    </div>

    <div class="row">
      <label class="toggle" title="Pro only / 专业版功能">
        <input type="checkbox" id="pinRisk" />
        <span><b>Pin Risk Lines</b> / 固定风控线 <span class="badge">Pro</span></span>
      </label>
    </div>

    <div class="footer">
      <b>Disclaimer:</b> Educational only, not financial advice.<br/>
      <b>免责声明：</b>仅供学习交流，不构成投资建议。
    </div>
  </div>

  <div id="chartWrap">
    <div id="chartBox">
      <div id="chartTop">
        <div id="price">--</div>
        <div id="hint">Demo Mode · 演示模式</div>
      </div>
      <div id="chart"></div>
    </div>
  </div>

  <div class="panel">
    <h3>Symbol & Timeframe · 品种与周期</h3>
    <label class="small"><b>Symbol</b> / 品种（可任意输入）</label>
    <input id="symbol" type="text" placeholder="e.g. AAPL, NVDA, BTC-USD, TSLA..." value="AAPL" />

    <label class="small"><b>Timeframe</b> / 周期</label>
    <select id="tf">
      <option value="15">15m</option>
      <option value="60">1h</option>
      <option value="1D" selected>1D</option>
    </select>

    <button class="ghost" onclick="reload()">Load / 加载</button>

    <div class="hr"></div>

    <h3>Subscription · 订阅（演示模式）</h3>
    <label class="small"><b>Plan</b> / 套餐</label>
    <select id="plan">
      <option value="halfmonthly">Half-monthly / 半月 (14天)</option>
      <option value="monthly" selected>Monthly / 月付</option>
      <option value="annual">Annual / 年付</option>
      <option value="lifetime">Lifetime / 终身</option>
    </select>

    <div class="smallTxt">当前为本地演示版，所有订阅功能已模拟。<br/>真实版本将接入 Stripe 支付。</div>

    <div class="hr"></div>

    <h3>Live Signals · 实时信号</h3>
    <div id="signals">Loading… / 加载中…</div>

    <div class="hr"></div>

    <h3>Email Alerts <span class="badge">Pro</span> · 邮件提醒（演示）</h3>
    <input id="alertEmail" placeholder="Email / 邮箱（如 you@email.com）"/>
    <button class="primary" onclick="showToast('演示模式：提醒已保存（模拟）')">Save Alert / 保存提醒</button>

    <div class="hr"></div>

    <h3>Share & Export · 分享与导出</h3>
    <button class="ghost" onclick="copyShareLink()">Copy Share Link / 复制分享链接</button>
    <button class="ghost" onclick="exportChartPNG()">Export PNG / 导出图片</button>

    <div class="footer">Powered by DarriusAI · Inflection Hunter<br/>© 2025 Darrius FinTech Inc</div>
  </div>
</div>

<div id="toast"></div>

<script>
let toastTimer = null;
function showToast(msg) {
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.style.display = "block";
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.style.display = "none", 3000);
}

function setHint(msg) { document.getElementById("hint").innerText = msg; }
function fmt(n) {
  if (n === null || n === undefined || Number.isNaN(n)) return "--";
  const x = Number(n);
  return Math.abs(x) >= 1000 ? x.toFixed(2) : Math.abs(x) >= 1 ? x.toFixed(4) : x.toFixed(6);
}

// 图表初始化
let chart = LightweightCharts.createChart(document.getElementById("chart"), {
  layout: { background: { color: "#0b0f17" }, textColor: "#d1d4dc" },
  grid: { vertLines: { color: "transparent" }, horzLines: { color: "transparent" } },
  timeScale: { timeVisible: true, secondsVisible: false },
  rightPriceScale: { borderVisible: false },
  crosshair: { mode: 1 }
});
let candle = chart.addCandlestickSeries({ upColor: "#00ff88", downColor: "#ff4757", wickUpColor: "#00ff88", wickDownColor: "#ff4757", borderVisible: false });
let upLine = chart.addLineSeries({ color: "#00ff88", lineWidth: 2 });
let dnLine = chart.addLineSeries({ color: "#ff4757", lineWidth: 2 });
let riskPriceLines = [];

function clearRiskLines() {
  riskPriceLines.forEach(pl => { try { candle.removePriceLine(pl); } catch {} });
  riskPriceLines = [];
}
function addRiskLine(price, title, color) {
  if (isNaN(price)) return;
  const pl = candle.createPriceLine({ price: Number(price), color, lineWidth: 2, lineStyle: 2, axisLabelVisible: true, title });
  riskPriceLines.push(pl);
}

function calcMarketPulse(latest) {
  if (!latest) return { label: "Neutral / 中性", value: 50, color: "#9aa4b2" };
  const dir = latest.side === "B" ? 1 : -1;
  const conf = latest.confidence || 0.5;
  const score = dir * conf;
  const v = Math.round((score + 1) * 50);
  if (v > 75) return { label: "Bullish / 强多", value: v, color: "#00ff88" };
  if (v > 55) return { label: "Mild Bull / 偏多", value: v, color: "#7dffb6" };
  if (v > 45) return { label: "Neutral / 中性", value: v, color: "#9aa4b2" };
  if (v > 25) return { label: "Mild Bear / 偏空", value: v, color: "#ffb3a7" };
  return { label: "Bearish / 强空", value: v, color: "#ff4757" };
}

// 模拟数据生成
function generateMockData(symbol, tf) {
  const now = Math.floor(Date.now() / 1000);
  const interval = tf === "15" ? 900 : tf === "60" ? 3600 : 86400;
  const bars = [];
  let price = symbol.includes("BTC") ? 65000 : 170;
  let time = now - 200 * interval;

  for (let i = 0; i < 200; i++) {
    const change = (Math.random() - 0.5) * (symbol.includes("BTC") ? 1000 : 3);
    price = Math.max(price + change, price * 0.8);
    const open = price;
    const close = price + (Math.random() - 0.5) * 20;
    const high = Math.max(open, close) + Math.random() * 10;
    const low = Math.min(open, close) - Math.random() * 10;
    bars.push({ time, open, high, low, close });
    time += interval;
  }

  // 模拟信号
  const signals = [];
  const markers = [];
  const trendUp = [], trendDn = [];
  let lastSignalTime = 0;

  for (let i = 30; i < bars.length; i += Math.floor(Math.random() * 20) + 15) {
    if (i - lastSignalTime < 10) continue;
    const side = Math.random() > 0.5 ? "B" : "S";
    const confidence = 0.6 + Math.random() * 0.3;
    const signalPrice = bars[i].close;
    const entry = side === "B" ? signalPrice * 1.001 : signalPrice * 0.999;
    const stop = side === "B" ? entry * 0.95 : entry * 1.05;
    const targets = side === "B" 
      ? [entry * 1.05, entry * 1.10, entry * 1.18] 
      : [entry * 0.95, entry * 0.90, entry * 0.82];

    signals.push({
      side, confidence, signal_price: signalPrice, entry_price: entry,
      risk: { entry, stop, targets }
    });
    markers.push({ time: bars[i].time, text: side === "B" ? "B" : "S" });
    lastSignalTime = i;
  }

  // 模拟趋势线
  for (let i = 0; i < 150; i += 20) {
    trendUp.push({ time: bars[i].time, value: bars[i].low * 0.98 });
    trendUp.push({ time: bars[i+15].time, value: bars[i+15].low * 0.99 });
    trendDn.push({ time: bars[i].time, value: bars[i].high * 1.02 });
    trendDn.push({ time: bars[i+15].time, value: bars[i+15].high * 1.01 });
  }

  const latest = signals[0] || null;
  const backtest = { winrate: 0.68 };

  return { bars, signals, markers, trendLines: { up: trendUp, dn: trendDn }, latest, backtest };
}

async function reload() {
  const symbol = document.getElementById("symbol").value.trim() || "AAPL";
  const tf = document.getElementById("tf").value;

  setHint("Generating demo data… / 正在生成演示数据…");

  // 模拟延迟
  await new Promise(r => setTimeout(r, 800));

  const data = generateMockData(symbol, tf);

  candle.setData(data.bars);
  upLine.setData(data.trendLines.up);
  dnLine.setData(data.trendLines.dn);

  candle.setMarkers(data.markers.map(m => ({
    time: m.time,
    position: m.text === "B" ? "belowBar" : "aboveBar",
    color: m.text === "B" ? "#00ff88" : "#ff4757",
    shape: "circle",
    text: m.text
  })));

  const last = data.bars[data.bars.length - 1];
  document.getElementById("price").innerText = `${symbol} · ${fmt(last.close)} (${tf})`;

  // 信号列表
  const box = document.getElementById("signals");
  box.innerHTML = "";
  if (data.signals.length === 0) {
    box.innerHTML = `<div class="smallTxt">No recent signals / 暂无近期信号</div>`;
  } else {
    data.signals.slice(0, 12).forEach(x => {
      const div = document.createElement("div");
      div.className = "signal " + (x.side === "S" ? "sell" : "");
      const sideEN = x.side === "B" ? "BUY" : "SELL";
      const sideZH = x.side === "B" ? "买入" : "卖出";
      const conf = Math.round(x.confidence * 100) + "%";
      div.innerHTML = `<b>${sideEN} / ${sideZH}</b> @ ${fmt(x.signal_price)}<br/><span class="smallTxt">Entry/入场: ${fmt(x.entry_price)} · Conf/强度: ${conf}</span>`;
      box.appendChild(div);
    });
  }

  // 市场情绪
  const pulse = calcMarketPulse(data.latest);
  document.getElementById("pulseCircle").innerText = pulse.value;
  document.getElementById("pulseCircle").style.borderColor = pulse.color;
  document.getElementById("pulseLabel").innerText = `Market Pulse: ${pulse.label}`;

  // 风控
  const risk = data.latest?.risk || null;
  document.getElementById("riskEntry").innerText = risk ? fmt(risk.entry) : "--";
  document.getElementById("riskStop").innerText = risk ? fmt(risk.stop) : "--";
  document.getElementById("riskTargets").innerText = risk ? risk.targets.map(fmt).join(", ") : "--";
  document.getElementById("riskConf").innerText = data.latest ? Math.round(data.latest.confidence * 100) + "%" : "--";
  document.getElementById("riskWR").innerText = Math.round(data.backtest.winrate * 100) + "%";

  clearRiskLines();
  if (risk) {
    addRiskLine(risk.entry, "Entry / 入场", "#00ff88");
    addRiskLine(risk.stop, "Stop / 止损", "#ff4757");
    risk.targets.forEach((p, i) => addRiskLine(p, `T${i+1} / 目标${i+1}`, "#00d4ff"));
  }

  setHint("Demo Mode · 演示模式 · 数据已加载");
  showToast("演示数据加载完成！");
}

// 模拟订阅
function simulateCheckout() {
  const plan = document.getElementById("plan").options[document.getElementById("plan").selectedIndex].text;
  showToast(`已选择 ${plan} — 演示模式下订阅成功！（真实版将跳转 Stripe）`);
  document.getElementById("status").innerText = `Pro Activated (${plan}) / 专业版已激活`;
  document.getElementById("status").style.background = "linear-gradient(90deg,#00ff88,#00d4ff)";
  document.getElementById("status").style.color = "#000";
  document.getElementById("upgradeBtn").style.display = "none";
  document.getElementById("manageBtn").style.display = "inline-block";
}
function simulatePortal() {
  showToast("订阅管理页面（演示模式） — 可取消或修改套餐");
}

// 分享与导出保持原有逻辑（导出有效）
async function copyShareLink() {
  const url = window.location.href + `?symbol=${document.getElementById("symbol").value}&tf=${document.getElementById("tf").value}`;
  await navigator.clipboard.writeText(url);
  showToast("分享链接已复制！");
}

function exportChartPNG() {
  // 原有导出逻辑（有效）
  const target = document.getElementById("chartBox");
  const rect = target.getBoundingClientRect();
  const canvases = target.querySelectorAll("canvas");
  if (canvases.length === 0) { showToast("未找到图表"); return; }

  const out = document.createElement("canvas");
  out.width = rect.width * devicePixelRatio;
  out.height = rect.height * devicePixelRatio;
  const ctx = out.getContext("2d");
  ctx.scale(devicePixelRatio, devicePixelRatio);
  ctx.fillStyle = "#0b0f17";
  ctx.fillRect(0, 0, rect.width, rect.height);

  // 绘制顶部栏
  const priceText = document.getElementById("price").innerText;
  const hintText = document.getElementById("hint").innerText;
  ctx.fillStyle = "rgba(0,0,0,0.6)";
  ctx.fillRect(12, 12, 360, 32);
  ctx.fillStyle = "#e6edf3";
  ctx.font = "900 14px -apple-system";
  ctx.fillText(priceText, 22, 33);

  const hintW = 520;
  const hintX = rect.width - hintW - 12;
  ctx.fillStyle = "rgba(0,0,0,0.55)";
  ctx.fillRect(hintX, 12, hintW, 32);
  ctx.fillStyle = "#9aa4b2";
  ctx.font = "600 12px -apple-system";
  ctx.fillText(hintText.slice(0, 70), hintX + 10, 33);

  canvases.forEach(c => {
    const r = c.getBoundingClientRect();
    ctx.drawImage(c, r.left - rect.left, r.top - rect.top);
  });

  // 水印
  ctx.save();
  ctx.globalAlpha = 0.14;
  ctx.translate(rect.width / 2, rect.height / 2);
  ctx.rotate(-Math.PI / 10);
  ctx.fillStyle = "#00ff88";
  ctx.font = "900 64px -apple-system";
  ctx.fillText("INFLECTION HUNTER PRO", -200, 0);
  ctx.restore();

  const a = document.createElement("a");
  a.download = `inflection-hunter_${document.getElementById("symbol").value}_${document.getElementById("tf").value}.png`;
  a.href = out.toDataURL();
  a.click();
  showToast("图片已导出！");
}

// 启动
document.getElementById("symbol").addEventListener("input", () => { if (event.inputType === "insertReplacementText" || event.inputType === undefined) reload(); });
document.getElementById("tf").addEventListener("change", reload);
reload();
</script>
</body>
</html>
