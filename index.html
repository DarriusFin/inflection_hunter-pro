<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>Inflection Hunter Pro v6.3.2 │ Darrius FinTech Inc</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<style>
:root{--bg:#0b0f17;--panel:#141a24;--panel2:#0f1522;--border:#2a3244;--text:#e6edf3;--muted:#9aa4b2;--green:#00ff88;--red:#ff4757;--blue:#00d4ff;--orange:#ffaa00;}
*{box-sizing:border-box}
body{margin:0;background:radial-gradient(circle at top left,#182035,#0b0f17);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;}
#topbar{height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 18px;background:rgba(20,26,36,.95);border-bottom:1px solid var(--border);gap:12px;}
#brand{display:flex;align-items:center;gap:14px;min-width:260px;}
#logo{font-size:26px;font-weight:900;background:linear-gradient(90deg,var(--green),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:.5px;}
#brandMeta{line-height:1.1}
#brandTitle{font-weight:900}
#subtitle{font-size:12px;color:var(--muted);margin-top:2px}
#topRight{display:flex;align-items:center;justify-content:flex-end;gap:10px;flex:1;min-width:0;}
#status{padding:7px 12px;border-radius:999px;font-size:12px;background:linear-gradient(90deg,#00ff88,#00d4ff);color:#000;white-space:nowrap;}
#copyright{font-size:12px;color:#fff;opacity:0.85;background:rgba(0,0,0,0.35);border:1px solid rgba(255,255,255,0.08);padding:6px 12px;border-radius:999px;white-space:nowrap;max-width:38vw;overflow:hidden;text-overflow:ellipsis;}
#main{display:grid;grid-template-columns:320px 1fr 360px;height:calc(100vh - 64px);}
.panel{background:var(--panel);border-right:1px solid var(--border);padding:16px;overflow:auto;}
.panel:last-child{border-right:none;}
.panel h3{margin:0 0 12px;font-size:14px;color:var(--green);display:flex;align-items:center;gap:8px;}
.panel h3::before{content:"◆";font-size:11px;opacity:.9}
#pulse{display:flex;align-items:center;justify-content:center;height:160px;}
#pulseCircle{width:122px;height:122px;border-radius:50%;border:10px solid var(--green);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900;background:rgba(0,0,0,.25);}
#pulseLabel{text-align:center;margin-top:8px;font-size:12px;color:var(--muted);line-height:1.4;}
.box{border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--panel2);}
.kv{display:flex;justify-content:space-between;gap:10px;margin:6px 0;font-size:13px}
.kv .k{color:var(--muted)} .kv .v{font-weight:900}
.badge{font-size:11px;padding:3px 8px;border-radius:999px;background:#26304a;border:1px solid rgba(255,255,255,.08);color:#cfe8ff;}
#chartWrap{position:relative;height:100%;}
#chartBox{position:absolute;inset:0;display:flex;flex-direction:column;}
#chartTop{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;z-index:10;}
#price{background:rgba(0,0,0,.6);padding:8px 12px;border-radius:12px;font-weight:900;border:1px solid rgba(255,255,255,0.10);}
#hint{background:rgba(0,0,0,.55);padding:8px 12px;border-radius:12px;font-size:12px;color:var(--muted);border:1px solid rgba(255,255,255,0.10);max-width:56%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
#chart{flex:1;width:100%;}
input,select,button{width:100%;margin:6px 0;padding:10px 10px;border-radius:10px;border:1px solid var(--border);background:var(--panel2);color:var(--text);font-size:13px;}
button{cursor:pointer;font-weight:900;}
button.primary{background:linear-gradient(90deg,var(--green),var(--blue));color:#000;border:none;padding:16px;font-size:16px;}
button.load-btn{background:linear-gradient(90deg,var(--green),var(--blue));color:#000;border:none;padding:16px;font-size:16px;}
button.ghost{background:#1e2533;}
.signal.latest{border-left:6px solid var(--green);padding:16px;margin:12px 0;background:var(--panel2);border-radius:12px;font-size:15px;font-weight:900;}
.signal.latest.sell{border-left-color:var(--red);}
.smallTxt{font-size:12px;color:var(--muted);line-height:1.5;}
.hr{height:1px;background:rgba(255,255,255,.06);margin:12px 0}
.footer{text-align:center;font-size:12px;color:var(--muted);margin-top:12px;line-height:1.55;}
#toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:rgba(0,0,0,.75);border:1px solid rgba(255,255,255,.14);padding:10px 14px;border-radius:999px;font-size:13px;color:#fff;z-index:99999;display:none;max-width:92vw;}
#signals{max-height:300px;overflow-y:auto;}
@media (max-width:1080px){#main{grid-template-columns:1fr;height:auto}.panel{border-right:none;border-bottom:1px solid var(--border)}#chartWrap{height:60vh}#copyright{display:none}#hint{max-width:70%}}
</style>
</head>
<body>

<div id="topbar">
  <div id="brand">
    <div id="logo">拐点猎手</div>
    <div id="brandMeta">
      <div id="brandTitle">Inflection Hunter Pro</div>
      <div id="subtitle">Darrius FinTech Inc</div>
    </div>
  </div>
  <div id="topRight">
    <span id="status">Pro Activated · Real-time / 专业版已激活</span>
    <span id="copyright">© 2025 Darrius FinTech Inc. All Rights Reserved.</span>
  </div>
</div>

<div id="main">
  <div class="panel">
    <h3>Market Pulse · 市场情绪</h3>
    <div id="pulse"><div id="pulseCircle">--</div></div>
    <div id="pulseLabel">Loading… / 加载中…</div>

    <div class="hr"></div>

    <h3>Risk Copilot · 风控助手</h3>
    <div class="box">
      <div class="kv"><span class="k">Entry · 入场</span><span class="v" id="riskEntry">--</span></div>
      <div class="kv"><span class="k">Stop · 止损</span><span class="v" id="riskStop">--</span></div>
      <div class="kv"><span class="k">Targets · 目标</span><span class="v" id="riskTargets">--</span></div>
      <div class="kv"><span class="k">Confidence · 强度</span><span class="v" id="riskConf">--</span></div>
      <div class="kv"><span class="k">Backtest WinRate · 回测胜率</span><span class="v" id="riskWR">--</span></div>
    </div>

    <div class="hr"></div>

    <h3>Live Signals · 实时信号</h3>
    <div id="signals">Connecting to Binance... / 连接Binance中...</div>

    <div class="footer">
      <b>Disclaimer · 免责声明:</b> Educational only, not financial advice. / 仅供学习交流，不构成投资建议。
    </div>
  </div>

  <div id="chartWrap">
    <div id="chartBox">
      <div id="chartTop">
        <div id="price">--</div>
        <div id="hint">Connecting to Binance · 连接Binance中</div>
      </div>
      <div id="chart"></div>
    </div>
  </div>

  <div class="panel">
    <h3>Symbol & Timeframe · 品种与周期</h3>
    <label class="small"><b>Symbol · 品种</b>（Binance格式，如 BTCUSDT）</label>
    <input id="symbol" type="text" placeholder="e.g. BTCUSDT, ETHUSDT..." value="BTCUSDT" />

    <label class="small"><b>Timeframe · 周期</b></label>
    <select id="tf">
      <option value="5m">5m · 5分钟</option>
      <option value="15m">15m · 15分钟</option>
      <option value="30m">30m · 30分钟</option>
      <option value="1h">1h · 1小时</option>
      <option value="4h">4h · 4小时</option>
      <option value="1d" selected>1d · 日线</option>
      <option value="1w">1w · 周线</option>
      <option value="1M">1M · 月线</option>
    </select>

    <button class="load-btn" onclick="reload()">Load · 加载</button>

    <div class="hr"></div>

    <h3>Subscription · 订阅</h3>
    <label class="small"><b>Plan · 套餐</b></label>
    <select id="plan">
      <option value="halfmonthly">Half-monthly · 半月 - $9.9</option>
      <option value="monthly">Monthly · 月付 - $19.99</option>
      <option value="annual">Annual · 年付 - $99</option>
      <option value="lifetime">Lifetime · 终身 - $299</option>
    </select>

    <button class="primary" onclick="startSubscription()">Subscribe · 订阅</button>
    <div class="smallTxt">Select plan and click to pay via Stripe · 选择套餐后点击跳转支付</div>

    <div class="hr"></div>

    <h3>Email Alerts · 邮件提醒 <span class="badge">Pro</span></h3>
    <input id="alertEmail" placeholder="you@email.com" />
    <button class="primary" onclick="showToast('Alert Saved · 已保存')">Save Alert · 保存提醒</button>
    <div class="smallTxt" id="alertHint">Pro Feature · 专业版功能</div>

    <div class="hr"></div>

    <h3>Share & Export · 分享与导出</h3>
    <button class="ghost" onclick="copyShareLink()">Copy Share Link · 复制分享链接</button>
    <button class="ghost" onclick="exportChartPNG()">Export PNG · 导出图片</button>

    <div class="footer">Powered by DarriusAI · Inflection Hunter<br/>© 2025 Darrius FinTech Inc</div>
  </div>
</div>

<div id="toast"></div>

<script>
/** =======================
 * constants & helpers
 * ======================= */
const GREEN="#00ff88", RED="#ff4757", BLUE="#00d4ff", ORANGE="#ffaa00";
let toastTimer=null;

function showToast(msg){
  const t=document.getElementById("toast");
  t.innerText=msg; t.style.display="block";
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.style.display="none",3000);
}
function setHint(msg){ document.getElementById("hint").innerText=msg; }
function fmt(n){
  if(n===null||n===undefined||isNaN(n)) return "--";
  const x=Number(n);
  return Math.abs(x)>=1000 ? x.toFixed(2) : x.toFixed(4);
}

// ✅ sort + dedup: 保证 setData 不黑屏
function normalizePoints(pts){
  pts.sort((a,b)=>a.time-b.time);
  const out=[];
  let lastT=null;
  for(const p of pts){
    if(!p || p.value===null || p.value===undefined || isNaN(p.value)) continue;
    if(lastT===p.time){
      out[out.length-1]=p; // 覆盖同time
    }else{
      out.push(p);
      lastT=p.time;
    }
  }
  return out;
}

/** =======================
 * chart init
 * ======================= */
let chart = LightweightCharts.createChart(document.getElementById("chart"), {
  layout:{ background:{ color:"#0b0f17" }, textColor:"#d1d4dc" },
  grid:{ vertLines:{ color:"transparent" }, horzLines:{ color:"transparent" } },
  timeScale:{ timeVisible:true, secondsVisible:false },
  rightPriceScale:{ borderVisible:false },
  crosshair:{ mode:1 }
});

let candle = chart.addCandlestickSeries({
  upColor:GREEN, downColor:RED,
  wickUpColor:GREEN, wickDownColor:RED,
  borderVisible:false
});

// ✅ 主线两条（绿/红）互斥显示 = MT 的 Uptrend/Dntrend
let mainUp = chart.addLineSeries({ color: GREEN, lineWidth: 3 });
let mainDn = chart.addLineSeries({ color: RED,   lineWidth: 3 });

// ✅ 辅助线：EMA20 黄色
let auxLineSeries = chart.addLineSeries({ color: ORANGE, lineWidth: 2 });

// risk lines
let riskPriceLines=[];
function clearRiskLines(){
  riskPriceLines.forEach(pl=>{ try{ candle.removePriceLine(pl);}catch{} });
  riskPriceLines=[];
}
function addRiskLine(price,title,color){
  if(isNaN(price)) return;
  const pl=candle.createPriceLine({ price, color, lineWidth:2, lineStyle:2, axisLabelVisible:true, title });
  riskPriceLines.push(pl);
}

/** =======================
 * store & pulse
 * ======================= */
let barsStore=[];
let currentSymbol="BTCUSDT";
let currentTf="1d";
let ws=null;

function calcMarketPulse(latest){
  if(!latest) return { label:"Neutral · 中性", value:50, color:"#9aa4b2" };
  const dir=latest.side==="B"?1:-1;
  const v=Math.round(50 + dir*latest.confidence*40);
  if(v>75) return { label:"Bullish · 强多", value:v, color:GREEN };
  if(v>55) return { label:"Mild Bull · 偏多", value:v, color:"#7dffb6" };
  if(v>45) return { label:"Neutral · 中性", value:v, color:"#9aa4b2" };
  return { label:"Bearish · 强空", value:v, color:RED };
}

/** =======================
 * subscription & misc
 * ======================= */
function startSubscription(){
  const plan=document.getElementById("plan").value;
  let url="";
  if(plan==="halfmonthly") url="https://buy.stripe.com/4gM3cxdskbQm35Y0DWg7e03";
  else if(plan==="monthly") url="https://buy.stripe.com/cNi3cxdsk2fM6ia3Q8g7e02";
  else if(plan==="annual") url="https://buy.stripe.com/5kQ14p3RKf2y6iaeuMg7e01";
  else if(plan==="lifetime") url="https://buy.stripe.com/7sY6oJfAs4nU8qi9asg7e00";
  if(url){ showToast("Redirecting to payment · 跳转支付中..."); window.location.href=url; }
  else showToast("Please select a plan · 请先选择套餐");
}
function copyShareLink(){
  try{ navigator.clipboard.writeText(window.location.href); showToast("Link copied · 已复制分享链接"); }
  catch{ showToast("Copy failed · 复制失败"); }
}
function exportChartPNG(){ showToast("Export PNG · 导出图片（占位）"); }

/** =======================
 * data sources
 * ======================= */
function getBinanceInterval(tf){ return tf; }

function generateSimulatedData(symbol, tf){
  const tfSeconds={"5m":300,"15m":900,"30m":1800,"1h":3600,"4h":14400,"1d":86400,"1w":604800,"1M":2592000}[tf]||86400;
  const num=tf==="1M"?120:220;
  const now=Math.floor(Date.now()/1000);
  const base=symbol.includes("BTC")?67000:205;
  const vol=symbol.includes("BTC")?0.025:0.012;

  const bars=[];
  let price=base;
  let t=now-(num-1)*tfSeconds;
  for(let i=0;i<num;i++){
    const trend=Math.sin(i/18)*base*0.012;
    const noise=(Math.random()-0.5)*base*vol;
    price+=trend+noise; price=Math.max(price, base*0.5);

    const open=price;
    const close=price+(Math.random()-0.5)*base*0.006;
    const high=Math.max(open,close)+Math.random()*base*0.01;
    const low=Math.min(open,close)-Math.random()*base*0.01;

    bars.push({ time:t+i*tfSeconds, open:+open.toFixed(2), high:+high.toFixed(2), low:+low.toFixed(2), close:+close.toFixed(2) });
  }
  return bars;
}

async function loadHistoricalData(symbol, tf){
  const interval=getBinanceInterval(tf);
  const limit=tf==="1M"?120:500;
  let retries=3;

  while(retries>0){
    try{
      const resp=await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`);
      if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data=await resp.json();
      if(!data||data.length===0) throw new Error("No data");

      const bars=data.map(d=>({
        time:d[0]/1000,
        open:+d[1], high:+d[2], low:+d[3], close:+d[4]
      }));

      barsStore=bars;
      candle.setData(barsStore);
      processData(barsStore);
      setHint("Binance data loaded · Binance数据加载完成");
      return;
    }catch(e){
      retries--;
      if(retries===0){
        showToast("Binance interface error, using simulated data · Binance接口错误，使用模拟数据");
        barsStore=generateSimulatedData(symbol, tf);
        candle.setData(barsStore);
        processData(barsStore);
        setHint("Simulated data (Binance unavailable) · 模拟数据 (Binance不可用)");
      }else{
        await new Promise(r=>setTimeout(r,1200));
      }
    }
  }
}

function connectWebSocket(symbol, tf){
  if(ws){ try{ ws.close(); }catch{} }
  const interval=getBinanceInterval(tf);
  const stream=`${symbol.toLowerCase()}@kline_${interval}`;
  ws=new WebSocket(`wss://stream.binance.com:9443/ws/${stream}`);

  ws.onmessage=e=>{
    try{
      const msg=JSON.parse(e.data);
      if(!msg.k) return;
      const k=msg.k;
      const bar={ time:k.t/1000, open:+k.o, high:+k.h, low:+k.l, close:+k.c };

      const last=barsStore[barsStore.length-1];
      if(last && last.time===bar.time) barsStore[barsStore.length-1]=bar;
      else{
        barsStore.push(bar);
        if(barsStore.length>1200) barsStore=barsStore.slice(-1200);
      }

      candle.update(bar);

      if(k.x){ // only on candle close
        processData(barsStore);
      }
    }catch{}
  };
  ws.onclose=()=>setTimeout(()=>connectWebSocket(symbol, tf),3000);
}

/** =======================
 * indicator core (fixed)
 * - no null placeholder => no vertical spikes
 * - normalizePoints => no black screen
 * - B/S uses MT pivot rule
 * ======================= */
function processData(bars){
  if(!bars || bars.length<40) return;

  const closes=bars.map(b=>b.close);

  // EMA20
  function ema(arr, per){
    const res=new Array(arr.length).fill(NaN);
    const k=2/(per+1);
    let sum=0;
    for(let i=0;i<per;i++) sum+=arr[i];
    res[per-1]=sum/per;
    for(let i=per;i<arr.length;i++) res[i]=arr[i]*k+res[i-1]*(1-k);
    return res;
  }
  const auxEMA=ema(closes,20);

  const auxPts=[];
  for(let i=0;i<bars.length;i++){
    const v=auxEMA[i];
    if(!isNaN(v)) auxPts.push({ time: bars[i].time, value: v });
  }
  auxLineSeries.setData(normalizePoints(auxPts));

  // main ext (WMA smoothing)
  const period=14;
  const p=Math.max(2, Math.floor(Math.sqrt(period)));

  function wma(arr, per){
    const res=new Array(arr.length).fill(NaN);
    const weights=Array.from({length:per},(_,i)=>i+1);
    const wsum=weights.reduce((a,b)=>a+b,0);
    for(let i=per-1;i<arr.length;i++){
      let sum=0;
      for(let j=0;j<per;j++) sum+=arr[i-j]*weights[per-1-j];
      res[i]=sum/wsum;
    }
    return res;
  }

  const wma_half=wma(closes, Math.max(2, Math.floor(period/2)));
  const wma_full=wma(closes, period);

  const vect=new Array(closes.length).fill(NaN);
  for(let i=0;i<closes.length;i++){
    if(!isNaN(wma_half[i]) && !isNaN(wma_full[i])) vect[i]=2*wma_half[i]-wma_full[i];
  }

  const ext=new Array(closes.length).fill(NaN);
  for(let i=p-1;i<closes.length;i++){
    let sum=0,cnt=0;
    for(let j=0;j<p;j++){
      const vv=vect[i-j];
      if(!isNaN(vv)){ sum+=vv; cnt++; }
    }
    if(cnt>0) ext[i]=sum/cnt;
  }

  // trend by CLOSE slope
  const N=5;
  const trend=new Array(closes.length).fill(0);
  for(let i=1;i<closes.length;i++){
    let delta=0, found=0;
    for(let k=i;k>=1 && found<N;k--){
      const a=closes[k], b=closes[k-1];
      if(isNaN(a)||isNaN(b)) continue;
      delta+=(a-b); found++;
    }
    if(found===0) trend[i]=trend[i-1];
    else if(delta>0) trend[i]=1;
    else if(delta<0) trend[i]=-1;
    else trend[i]=trend[i-1];
  }

  // Up/Dn points (EMPTY_VALUE by skipping points)
  const upPts=[];
  const dnPts=[];
  for(let i=0;i<bars.length;i++){
    const v=ext[i];
    if(isNaN(v)) continue;

    // boundary stitch (like MT x+1) but safe: we'll normalize later
    if(i>0 && trend[i]!==trend[i-1] && !isNaN(ext[i-1])){
      const tPrev=bars[i-1].time;
      const vPrev=ext[i-1];
      if(trend[i]>0) upPts.push({ time:tPrev, value:vPrev });
      else if(trend[i]<0) dnPts.push({ time:tPrev, value:vPrev });
    }

    if(trend[i]>0) upPts.push({ time: bars[i].time, value: v });
    else if(trend[i]<0) dnPts.push({ time: bars[i].time, value: v });
    else{
      const prev=i>0?trend[i-1]:1;
      if(prev>=0) upPts.push({ time: bars[i].time, value: v });
      else dnPts.push({ time: bars[i].time, value: v });
    }
  }
  mainUp.setData(normalizePoints(upPts));
  mainDn.setData(normalizePoints(dnPts));

  // B/S: MT pivot rule (time ascending equivalent)
  const markers=[];
  for(let i=1;i<bars.length-1;i++){
    const a=ext[i-1], b=ext[i], c=ext[i+1];
    if(isNaN(a)||isNaN(b)||isNaN(c)) continue;

    // B: local minima
    if(b < a && b <= c){
      markers.push({
        time: bars[i].time,
        text: "B",
        position: "belowBar",
        color: "#ff2bd6",
        shape: "arrowUp"
      });
    }
    // S: local maxima
    if(b > a && b >= c){
      markers.push({
        time: bars[i].time,
        text: "S",
        position: "aboveBar",
        color: "#ffe600",
        shape: "arrowDown"
      });
    }
  }
  candle.setMarkers(markers);

  // latest signal: last pivot
  let latestSignal=null;
  for(let i=bars.length-2;i>=1;i--){
    const a=ext[i-1], b=ext[i], c=ext[i+1];
    if(isNaN(a)||isNaN(b)||isNaN(c)) continue;

    if(b < a && b <= c){
      latestSignal={ side:"B", confidence:0.85, signal_price:bars[i].low, entry_price:bars[i].low*1.002,
        risk:{ entry:bars[i].low*1.002, stop:bars[i].low*0.93, targets:[bars[i].low*1.07, bars[i].low*1.16, bars[i].low*1.28] } };
      break;
    }
    if(b > a && b >= c){
      latestSignal={ side:"S", confidence:0.85, signal_price:bars[i].high, entry_price:bars[i].high*0.998,
        risk:{ entry:bars[i].high*0.998, stop:bars[i].high*1.07, targets:[bars[i].high*0.93, bars[i].high*0.84, bars[i].high*0.72] } };
      break;
    }
  }

  // left panel signals
  const box=document.getElementById("signals");
  box.innerHTML="";
  if(latestSignal){
    const div=document.createElement("div");
    div.className="signal latest "+(latestSignal.side==="S"?"sell":"");
    const sideEN=latestSignal.side==="B"?"BUY":"SELL";
    const sideZH=latestSignal.side==="B"?"买入":"卖出";
    div.innerHTML=`<b>${sideEN} · ${sideZH}</b> @ ${fmt(latestSignal.signal_price)}<br/>
      <span class="smallTxt">Entry · 入场: ${fmt(latestSignal.entry_price)} · Confidence · 强度: ${Math.round(latestSignal.confidence*100)}%</span>`;
    box.appendChild(div);
  }else{
    box.innerHTML="<div class='smallTxt'>No recent signal · 暂无最新信号</div>";
  }

  // market pulse
  const pulse=calcMarketPulse(latestSignal);
  document.getElementById("pulseCircle").innerText = latestSignal ? pulse.value : "--";
  document.getElementById("pulseCircle").style.borderColor = pulse.color;
  document.getElementById("pulseLabel").innerText = latestSignal ? `Market Pulse · 市场情绪: ${pulse.label}` : "Loading… / 加载中…";

  // risk
  const risk=latestSignal?.risk || null;
  document.getElementById("riskEntry").innerText = risk ? fmt(risk.entry) : "--";
  document.getElementById("riskStop").innerText = risk ? fmt(risk.stop) : "--";
  document.getElementById("riskTargets").innerText = risk ? risk.targets.map(fmt).join(", ") : "--";
  document.getElementById("riskConf").innerText = latestSignal ? Math.round(latestSignal.confidence*100)+"%" : "--";
  document.getElementById("riskWR").innerText = "72%";

  clearRiskLines();
  if(risk){
    addRiskLine(risk.entry, "Entry · 入场", GREEN);
    addRiskLine(risk.stop, "Stop · 止损", RED);
    risk.targets.forEach((p,i)=>addRiskLine(p, `T${i+1} · 目标${i+1}`, BLUE));
  }

  // top price label
  const last=bars[bars.length-1];
  document.getElementById("price").innerText = `${currentSymbol} · ${fmt(last.close)}`;
}

async function reload(){
  const symbol=(document.getElementById("symbol").value||"BTCUSDT").trim().toUpperCase();
  const tf=document.getElementById("tf").value;
  currentSymbol=symbol;
  currentTf=tf;

  document.getElementById("signals").innerHTML="Connecting to Binance... / 连接Binance中...";
  setHint("Loading Binance data · 加载Binance数据中...");

  await loadHistoricalData(symbol, tf);
  connectWebSocket(symbol, tf);
}

// start
reload();
</script>
</body>
</html>
